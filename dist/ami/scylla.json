{
  "builders": [
    {
      "type": "amazon-ebs",
      "access_key": "{{user `access_key`}}",
      "secret_key": "{{user `secret_key`}}",
      "subnet_id": "{{user `subnet_id`}}",
      "security_group_id": "{{user `security_group_id`}}",
      "region": "{{user `region`}}",
      "associate_public_ip_address": "{{user `associate_public_ip_address`}}",
      "source_ami": "ami-76dfc41e",
      "instance_type": "{{user `instance_type`}}",
      "ssh_username": "fedora",
      "ssh_timeout": "5m",
      "ami_name": "scylla_{{isotime | clean_ami_name}}"
    }
  ],
  "provisioners": [
    {
      "type": "file",
      "source": "files/scylla-server.rpm",
      "destination": "/home/fedora/scylla-server.rpm"
    },
    {
      "type": "file",
      "source": "files/scylla-setup.sh",
      "destination": "/home/fedora/scylla-setup.sh"
    },
    {
      "type": "file",
      "source": "files/scylla-setup.service",
      "destination": "/home/fedora/scylla-setup.service"
    },
    {
      "type": "file",
      "source": "files/scylla-server",
      "destination": "/home/fedora/scylla-server"
    },
    {
      "type": "file",
      "source": "files/setup_yaml.py",
      "destination": "/home/fedora/setup_yaml.py"
    },
    {
      "type": "shell",
      "inline": [
        "sudo dnf update -y",
        "sudo dnf install -y /home/fedora/scylla-server.rpm",
        "sudo dnf install -y mdadm xfsprogs",
        "sudo mv /home/fedora/scylla-setup.service /usr/lib/systemd/system",
        "sudo mv /home/fedora/scylla-setup.sh /usr/lib/scylla",
        "sudo chmod a+rx /usr/lib/scylla/scylla-setup.sh",
	"sudo mv /home/fedora/setup_yaml.py /usr/lib/scylla",
	"sudo chmod a+rx /usr/lib/scylla/setup_yaml.py",
        "sudo cp scylla-server /etc/sysconfig",
        "sudo systemctl enable scylla-setup.service",
	"sudo sed -e 's!/var/lib/scylla/data!/data/data!' -e 's!commitlog_directory: /var/lib/scylla/commitlog!commitlog_directory: /data/commitlog!' /var/lib/scylla/conf/scylla.yaml > /tmp/scylla.yaml",
        "sudo mv /tmp/scylla.yaml /var/lib/scylla/conf"
      ]
    }
  ],
  "variables": {
    "access_key": "",
    "secret_key": "",
    "subnet_id": "",
    "security_group_id": "",
    "region": "",
    "associate_public_ip_address": "",
    "instance_type": ""
  }
}
